<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è©¦åˆçµæœå…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ </title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 900px;
            width: 100%;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            color: #666;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            bottom: -2px;
        }

        .tab:hover {
            color: #667eea;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
            text-align: center;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }

        input[type="text"],
        input[type="date"],
        input[type="number"] {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        input[type="text"]:focus,
        input[type="date"]:focus,
        input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .score-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .status-message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-weight: 500;
            display: none;
        }

        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-message.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .footer-info {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
        }

        .footer-info h4 {
            color: #666;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .url-display {
            background: #f8f9fa;
            padding: 12px 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #333;
            word-break: break-all;
            line-height: 1.6;
            border: 1px solid #e0e0e0;
        }

        .url-display.not-configured {
            color: #e74c3c;
            font-family: inherit;
            font-style: italic;
        }

        .url-display.configured {
            color: #28a745;
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .preview-header h3 {
            margin: 0;
            color: #333;
        }

        .reload-btn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .reload-btn:hover {
            background: #5568d3;
            transform: translateY(-1px);
        }

        .reload-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .preview-container {
            overflow-x: auto;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .data-table thead {
            background: #667eea;
            color: white;
        }

        .data-table th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            white-space: nowrap;
        }

        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
        }

        .data-table tbody tr:hover {
            background: #f8f9fa;
        }

        .data-table tbody tr:last-child td {
            border-bottom: none;
        }

        /* å‹æ•—åˆ—ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .result-cell {
            font-weight: 700;
            text-align: center;
        }

        .result-win {
            color: #28a745;
            background: #d4edda;
        }

        .result-lose {
            color: #fd7e14;
            background: #fff3cd;
        }

        .result-draw {
            color: #666;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .loading-state {
            text-align: center;
            padding: 40px 20px;
            color: #667eea;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-state {
            text-align: center;
            padding: 40px 20px;
            color: #e74c3c;
        }

        .data-count {
            color: #666;
            font-size: 14px;
            margin-top: 10px;
        }

        .stats-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            color: white;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
        }

        .stats-title {
            font-size: 16px;
            font-weight: 600;
            margin: 0;
        }

        @media (max-width: 600px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .stat-value {
                font-size: 20px;
            }
        }

        .required {
            color: #e74c3c;
        }

        .config-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .config-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .config-section small {
            color: #666;
            display: block;
            margin-top: 5px;
        }

        @media (max-width: 600px) {
            .container {
                padding: 30px 20px;
            }

            h1 {
                font-size: 24px;
            }

            .score-group {
                grid-template-columns: 1fr;
            }

            .tabs {
                gap: 5px;
            }

            .tab {
                padding: 10px 16px;
                font-size: 14px;
            }

            .preview-header {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }

            .reload-btn {
                width: 100%;
            }

            .data-table {
                font-size: 12px;
            }

            .data-table th,
            .data-table td {
                padding: 8px;
            }
        }

        /* ç·¨é›†ãƒ»å‰Šé™¤ãƒœã‚¿ãƒ³ */
        .action-btns {
            display: flex;
            gap: 5px;
            justify-content: center;
        }

        .edit-btn, .delete-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .edit-btn {
            background: #667eea;
            color: white;
        }

        .edit-btn:hover {
            background: #5568d3;
            transform: translateY(-1px);
        }

        .delete-btn {
            background: #e74c3c;
            color: white;
        }

        .delete-btn:hover {
            background: #c0392b;
            transform: translateY(-1px);
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s ease;
        }

        .modal.show {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            margin: 0;
            color: #333;
            font-size: 22px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            color: #999;
            cursor: pointer;
            line-height: 1;
            padding: 0;
        }

        .close-btn:hover {
            color: #333;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .modal-btn.primary {
            background: #667eea;
            color: white;
        }

        .modal-btn.primary:hover {
            background: #5568d3;
        }

        .modal-btn.secondary {
            background: #e0e0e0;
            color: #333;
        }

        .modal-btn.secondary:hover {
            background: #d0d0d0;
        }

        .modal-btn.danger {
            background: #e74c3c;
            color: white;
        }

        .modal-btn.danger:hover {
            background: #c0392b;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ è©¦åˆçµæœå…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ </h1>
        <p class="subtitle">å—ãƒ¶ä¸˜ã®è©¦åˆãƒ‡ãƒ¼ã‚¿ã‚’è¨˜éŒ²</p>

        <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('form')">ğŸ“ ãƒ‡ãƒ¼ã‚¿å…¥åŠ›</button>
            <button class="tab" onclick="switchTab('preview')">ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
        </div>

        <!-- ãƒ‡ãƒ¼ã‚¿å…¥åŠ›ã‚¿ãƒ– -->
        <div id="formTab" class="tab-content active">
            <form id="matchForm">
            <div class="form-group">
                <label for="date">æ—¥ä»˜ <span class="required">*</span></label>
                <input type="date" id="date" name="date" required />
            </div>

            <div class="form-group">
                <label for="tournament">å¤§ä¼šå <span class="required">*</span></label>
                <input type="text" id="tournament" name="tournament" placeholder="ä¾‹ï¼šç·´ç¿’è©¦åˆ" required />
            </div>

            <div class="form-group">
                <label for="venue">ä¼šå ´ <span class="required">*</span></label>
                <input type="text" id="venue" name="venue" placeholder="ä¾‹ï¼šå—å°å­¦æ ¡" required />
            </div>

            <div class="form-group">
                <label for="opponent">å¯¾æˆ¦ãƒãƒ¼ãƒ å <span class="required">*</span></label>
                <input type="text" id="opponent" name="opponent" placeholder="ä¾‹ï¼šè¥¿ãŒå²¡" required />
            </div>

            <div class="form-group">
                <label>ã‚¹ã‚³ã‚¢ <span class="required">*</span></label>
                <div class="score-group">
                    <div>
                        <input type="number" id="scoreMinamiGaoka" name="scoreMinamiGaoka" placeholder="å—ãƒ¶ä¸˜" min="0" required />
                    </div>
                    <div>
                        <input type="number" id="scoreOpponent" name="scoreOpponent" placeholder="å¯¾æˆ¦ãƒãƒ¼ãƒ " min="0" required />
                    </div>
                </div>
            </div>

            <button type="submit" class="btn" id="submitBtn">ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ </button>
        </form>

        <div id="statusMessage" class="status-message"></div>
        </div>

        <!-- ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¿ãƒ– -->
        <div id="previewTab" class="tab-content">
            <div class="preview-header">
                <h3>ğŸ“Š ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿</h3>
                <button class="reload-btn" onclick="loadPreviewData()">ğŸ”„ æ›´æ–°</button>
            </div>
            
            <div id="previewContent">
                <div class="loading-state">
                    <div class="loading-spinner"></div>
                    <p>ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
                </div>
            </div>
            
            <div class="data-count" id="dataCount"></div>
        </div>

        <div class="footer-info">
            <h4>ğŸ“¡ è¨­å®šæƒ…å ±</h4>
            <div id="urlDisplay" class="url-display"></div>
        </div>
    </div>

    <!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>âœï¸ ãƒ‡ãƒ¼ã‚¿ã‚’ç·¨é›†</h2>
                <button class="close-btn" onclick="closeEditModal()">&times;</button>
            </div>
            <form id="editForm">
                <input type="hidden" id="editRowIndex">
                
                <div class="form-group">
                    <label for="editDate">æ—¥ä»˜ <span class="required">*</span></label>
                    <input type="date" id="editDate" required />
                </div>

                <div class="form-group">
                    <label for="editTournament">å¤§ä¼šå <span class="required">*</span></label>
                    <input type="text" id="editTournament" required />
                </div>

                <div class="form-group">
                    <label for="editVenue">ä¼šå ´ <span class="required">*</span></label>
                    <input type="text" id="editVenue" required />
                </div>

                <div class="form-group">
                    <label for="editOpponent">å¯¾æˆ¦ãƒãƒ¼ãƒ å <span class="required">*</span></label>
                    <input type="text" id="editOpponent" required />
                </div>

                <div class="form-group">
                    <label>ã‚¹ã‚³ã‚¢ <span class="required">*</span></label>
                    <div class="score-group">
                        <div>
                            <input type="number" id="editScoreMinamiGaoka" placeholder="å—ãƒ¶ä¸˜" min="0" required />
                        </div>
                        <div>
                            <input type="number" id="editScoreOpponent" placeholder="å¯¾æˆ¦ãƒãƒ¼ãƒ " min="0" required />
                        </div>
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="modal-btn secondary" onclick="closeEditModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="submit" class="modal-btn primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ—‘ï¸ ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤</h2>
                <button class="close-btn" onclick="closeDeleteModal()">&times;</button>
            </div>
            <p style="margin: 20px 0; color: #666;">ã“ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</p>
            <div id="deletePreview" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0;"></div>
            <input type="hidden" id="deleteRowIndex">
            <div class="modal-actions">
                <button type="button" class="modal-btn secondary" onclick="closeDeleteModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="button" class="modal-btn danger" onclick="confirmDelete()">å‰Šé™¤</button>
            </div>
        </div>
    </div>

    <script>
        // ===== è¨­å®š: ã“ã“ã«Google Apps Script URLã‚’è¨­å®šã—ã¦ãã ã•ã„ =====
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbye14S2FIyZsXir7_S0ZeWGNxigrp9OVIfC-Ht9hs71pcAIP-BwSm1JJES5TVe1Qam7/exec';
        // ============================================================

        // LocalStorageã‹ã‚‰å€¤ã‚’èª­ã¿è¾¼ã¿
        window.addEventListener('DOMContentLoaded', () => {
            // å¤§ä¼šåã¨ä¼šå ´åã‚’å¾©å…ƒ
            const savedTournament = localStorage.getItem('tournament');
            if (savedTournament) {
                document.getElementById('tournament').value = savedTournament;
            }

            const savedVenue = localStorage.getItem('venue');
            if (savedVenue) {
                document.getElementById('venue').value = savedVenue;
            }

            // ä»Šæ—¥ã®æ—¥ä»˜ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§è¨­å®š
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;

            // URLæƒ…å ±ã‚’è¡¨ç¤º
            displayScriptUrl();
        });

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function switchTab(tabName) {
            // ã™ã¹ã¦ã®ã‚¿ãƒ–ã¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // é¸æŠã•ã‚ŒãŸã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
            if (tabName === 'form') {
                document.querySelectorAll('.tab')[0].classList.add('active');
                document.getElementById('formTab').classList.add('active');
            } else if (tabName === 'preview') {
                document.querySelectorAll('.tab')[1].classList.add('active');
                document.getElementById('previewTab').classList.add('active');
                // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¿ãƒ–ã‚’é–‹ã„ãŸã¨ãã«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
                loadPreviewData();
            }
        }

        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
        async function loadPreviewData() {
            if (!SCRIPT_URL || SCRIPT_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') {
                showPreviewError('Google Apps Script URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }

            const previewContent = document.getElementById('previewContent');
            const dataCount = document.getElementById('dataCount');
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            previewContent.innerHTML = `
                <div class="loading-state">
                    <div class="loading-spinner"></div>
                    <p>ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
                </div>
            `;
            dataCount.textContent = '';

            try {
                const response = await fetch(SCRIPT_URL);
                const result = await response.json();

                if (result.status === 'success') {
                    if (result.data && result.data.length > 0) {
                        displayPreviewData(result.data, result.stats);
                        dataCount.textContent = `${result.count}ä»¶ã®ãƒ‡ãƒ¼ã‚¿`;
                    } else {
                        showPreviewEmpty();
                    }
                } else {
                    showPreviewError(result.message || 'ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                console.error('Preview error:', error);
                showPreviewError('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
        function displayPreviewData(data, stats) {
            const previewContent = document.getElementById('previewContent');
            
            let html = '';
            
            // é›†è¨ˆæƒ…å ±ã‚’è¡¨ç¤ºï¼ˆJ1~N2ï¼‰
            if (stats && stats.length === 2) {
                const labels = stats[0]; // 1è¡Œç›®ï¼šãƒ©ãƒ™ãƒ«
                const values = stats[1]; // 2è¡Œç›®ï¼šå€¤
                
                html += `
                    <div class="stats-container">
                        <h3 class="stats-title">ğŸ“Š é›†è¨ˆæƒ…å ±</h3>
                        <div class="stats-grid">
                `;
                
                for (let i = 0; i < labels.length && i < values.length; i++) {
                    if (labels[i] !== '' || values[i] !== '') {
                        const label = String(labels[i]);
                        let value = values[i];
                        
                        // å‹ç‡ã®å ´åˆã¯ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆè¡¨ç¤ºã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                        if (label.includes('å‹ç‡') || label.toLowerCase().includes('rate') || label.toLowerCase().includes('win')) {
                            value = formatPercentage(value);
                        } else {
                            value = String(value);
                        }
                        
                        html += `
                            <div class="stat-item">
                                <div class="stat-label">${escapeHtml(label)}</div>
                                <div class="stat-value">${escapeHtml(value)}</div>
                            </div>
                        `;
                    }
                }
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            // ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¡¨ç¤º
            html += `
                <div class="preview-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>æ—¥ä»˜</th>
                                <th>å¤§ä¼šå</th>
                                <th>ä¼šå ´</th>
                                <th>å¯¾æˆ¦ãƒãƒ¼ãƒ </th>
                                <th>å—ãƒ¶ä¸˜</th>
                                <th>å¯¾æˆ¦ç›¸æ‰‹</th>
                                <th>å‹æ•—</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            data.forEach(row => {
                // æ—¥ä»˜ã‚’ã‚¹ãƒ©ãƒƒã‚·ãƒ¥åŒºåˆ‡ã‚Šã«å¤‰æ›
                const formattedDate = formatDateForDisplay(row.date);
                
                // å‹æ•—ã«å¿œã˜ãŸã‚¯ãƒ©ã‚¹ã‚’æ±ºå®š
                const result = String(row.result || '').trim();
                let resultClass = 'result-cell';
                if (result === 'å‹' || result === 'å‹ã¡') {
                    resultClass += ' result-win';
                } else if (result === 'è² ' || result === 'è² ã‘') {
                    resultClass += ' result-lose';
                } else if (result === 'å¼•ãåˆ†ã‘' || result === 'åˆ†') {
                    resultClass += ' result-draw';
                }
                
                html += `
                    <tr>
                        <td>${escapeHtml(formattedDate)}</td>
                        <td>${escapeHtml(row.tournament)}</td>
                        <td>${escapeHtml(row.venue)}</td>
                        <td>${escapeHtml(row.opponent)}</td>
                        <td>${escapeHtml(row.scoreMinamiGaoka)}</td>
                        <td>${escapeHtml(row.scoreOpponent)}</td>
                        <td class="${resultClass}">${escapeHtml(result)}</td>
                        <td>
                            <div class="action-btns">
                                <button class="edit-btn" onclick='openEditModal(${JSON.stringify(row)})'>ç·¨é›†</button>
                                <button class="delete-btn" onclick='openDeleteModal(${JSON.stringify(row)})'>å‰Šé™¤</button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            previewContent.innerHTML = html;
        }

        // ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆè¡¨ç¤ºã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆå°æ•°ç‚¹ä»¥ä¸‹2æ¡ï¼‰
        function formatPercentage(value) {
            if (value === '' || value === null || value === undefined) {
                return '';
            }
            
            try {
                let numValue = parseFloat(value);
                
                // æ—¢ã«ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆå€¤ï¼ˆ0-100ã®ç¯„å›²ï¼‰ã®å ´åˆ
                if (numValue > 1) {
                    return numValue.toFixed(2) + '%';
                }
                
                // å°æ•°ï¼ˆ0-1ã®ç¯„å›²ï¼‰ã®å ´åˆã¯100å€ã—ã¦ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆè¡¨ç¤º
                return (numValue * 100).toFixed(2) + '%';
            } catch (error) {
                // æ•°å€¤ã«å¤‰æ›ã§ããªã„å ´åˆã¯ãã®ã¾ã¾è¿”ã™
                return String(value);
            }
        }

        // æ—¥ä»˜ã‚’YYYY/MM/DDå½¢å¼ã§ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatDateForDisplay(dateStr) {
            if (!dateStr) return '';
            
            try {
                // æ—¢ã«YYYY/MM/DDå½¢å¼ã®å ´åˆã¯ãã®ã¾ã¾è¿”ã™
                if (/^\d{4}\/\d{2}\/\d{2}$/.test(dateStr)) {
                    return dateStr;
                }
                
                // YYYY-MM-DDå½¢å¼ã®å ´åˆã¯ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã«å¤‰æ›
                if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                    return dateStr.replace(/-/g, '/');
                }
                
                // ISOå½¢å¼ï¼ˆYYYY-MM-DDTHH:mm:ss.sssZï¼‰ã®å ´åˆ
                if (dateStr.includes('T')) {
                    const date = new Date(dateStr);
                    if (!isNaN(date.getTime())) {
                        const year = date.getFullYear();
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        const day = String(date.getDate()).padStart(2, '0');
                        return `${year}/${month}/${day}`;
                    }
                }
                
                // ãã®ä»–ã®å½¢å¼ã®å ´åˆã‚‚Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦ãƒ‘ãƒ¼ã‚¹
                const date = new Date(dateStr);
                if (!isNaN(date.getTime())) {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}/${month}/${day}`;
                }
                
                // ãƒ‘ãƒ¼ã‚¹ã§ããªã„å ´åˆã¯å…ƒã®æ–‡å­—åˆ—ã‚’è¿”ã™
                return dateStr;
            } catch (error) {
                console.error('Date formatting error:', error);
                return dateStr;
            }
        }

        // ç©ºã®ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º
        function showPreviewEmpty() {
            const previewContent = document.getElementById('previewContent');
            previewContent.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ“­</div>
                    <p>ãƒ‡ãƒ¼ã‚¿ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“</p>
                    <p style="font-size: 14px; color: #999;">ãƒ‡ãƒ¼ã‚¿å…¥åŠ›ã‚¿ãƒ–ã‹ã‚‰è©¦åˆçµæœã‚’è¿½åŠ ã—ã¦ãã ã•ã„</p>
                </div>
            `;
        }

        // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
        function showPreviewError(message) {
            const previewContent = document.getElementById('previewContent');
            previewContent.innerHTML = `
                <div class="error-state">
                    <div class="empty-state-icon">âš ï¸</div>
                    <p>${escapeHtml(message)}</p>
                </div>
            `;
        }

        // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // å¤§ä¼šåã®ä¿å­˜
        const tournamentInput = document.getElementById('tournament');
        tournamentInput.addEventListener('blur', (e) => {
            if (e.target.value.trim() !== '') {
                localStorage.setItem('tournament', e.target.value.trim());
            }
        });
        tournamentInput.addEventListener('change', (e) => {
            if (e.target.value.trim() !== '') {
                localStorage.setItem('tournament', e.target.value.trim());
            }
        });

        // ä¼šå ´åã®ä¿å­˜
        const venueInput = document.getElementById('venue');
        venueInput.addEventListener('blur', (e) => {
            if (e.target.value.trim() !== '') {
                localStorage.setItem('venue', e.target.value.trim());
            }
        });
        venueInput.addEventListener('change', (e) => {
            if (e.target.value.trim() !== '') {
                localStorage.setItem('venue', e.target.value.trim());
            }
        });

        document.getElementById('matchForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            // URLãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
            if (!SCRIPT_URL || SCRIPT_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') {
                showMessage('ã‚¨ãƒ©ãƒ¼: HTMLãƒ•ã‚¡ã‚¤ãƒ«å†…ã®SCRIPT_URLã‚’è¨­å®šã—ã¦ãã ã•ã„', 'error');
                return;
            }

            const formData = {
                action: 'add',
                date: document.getElementById('date').value,
                tournament: document.getElementById('tournament').value,
                venue: document.getElementById('venue').value,
                opponent: document.getElementById('opponent').value,
                scoreMinamiGaoka: document.getElementById('scoreMinamiGaoka').value,
                scoreOpponent: document.getElementById('scoreOpponent').value
            };

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'é€ä¿¡ä¸­...';

            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                // no-corsãƒ¢ãƒ¼ãƒ‰ã§ã¯å®Ÿéš›ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å—ã‘å–ã‚Œãªã„ãŸã‚ã€
                // ã‚¨ãƒ©ãƒ¼ãŒãªã‘ã‚Œã°æˆåŠŸã¨ã¿ãªã™
                showMessage('ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼', 'success');
                
                // å¯¾æˆ¦ãƒãƒ¼ãƒ åã¨ã‚¹ã‚³ã‚¢ã®ã¿ã‚¯ãƒªã‚¢ï¼ˆå¤§ä¼šåã¨ä¼šå ´åã¯ä¿æŒï¼‰
                document.getElementById('opponent').value = '';
                document.getElementById('scoreMinamiGaoka').value = '';
                document.getElementById('scoreOpponent').value = '';
                
                // æ—¥ä»˜ã‚’ä»Šæ—¥ã«æˆ»ã™
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('date').value = today;

                // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¿ãƒ–ãŒé–‹ã„ã¦ã„ã‚‹å ´åˆã¯æ›´æ–°
                setTimeout(() => {
                    if (document.getElementById('previewTab').classList.contains('active')) {
                        loadPreviewData();
                    }
                }, 1000);

            } catch (error) {
                console.error('Error:', error);
                showMessage('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚URLã¨ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ';
            }
        });

        function showMessage(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `status-message ${type} show`;
            
            setTimeout(() => {
                statusDiv.classList.remove('show');
            }, 5000);
        }

        function displayScriptUrl() {
            const urlDisplay = document.getElementById('urlDisplay');
            
            if (!SCRIPT_URL || SCRIPT_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') {
                urlDisplay.textContent = 'âš ï¸ Google Apps Script URLãŒæœªè¨­å®šã§ã™ã€‚HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã—ã¦SCRIPT_URLã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚';
                urlDisplay.className = 'url-display not-configured';
            } else {
                urlDisplay.textContent = `âœ“ æ¥ç¶šå…ˆ: ${SCRIPT_URL}`;
                urlDisplay.className = 'url-display configured';
            }
        }

        // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openEditModal(row) {
            document.getElementById('editRowIndex').value = row.rowIndex;
            document.getElementById('editDate').value = row.date.replace(/\//g, '-');
            document.getElementById('editTournament').value = row.tournament;
            document.getElementById('editVenue').value = row.venue;
            document.getElementById('editOpponent').value = row.opponent;
            document.getElementById('editScoreMinamiGaoka').value = row.scoreMinamiGaoka;
            document.getElementById('editScoreOpponent').value = row.scoreOpponent;
            
            document.getElementById('editModal').classList.add('show');
        }

        // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeEditModal() {
            document.getElementById('editModal').classList.remove('show');
        }

        // ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã®é€ä¿¡
        document.getElementById('editForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!SCRIPT_URL || SCRIPT_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') {
                showMessage('ã‚¨ãƒ©ãƒ¼: HTMLãƒ•ã‚¡ã‚¤ãƒ«å†…ã®SCRIPT_URLã‚’è¨­å®šã—ã¦ãã ã•ã„', 'error');
                return;
            }

            const formData = {
                action: 'edit',
                rowIndex: parseInt(document.getElementById('editRowIndex').value),
                date: document.getElementById('editDate').value,
                tournament: document.getElementById('editTournament').value,
                venue: document.getElementById('editVenue').value,
                opponent: document.getElementById('editOpponent').value,
                scoreMinamiGaoka: document.getElementById('editScoreMinamiGaoka').value,
                scoreOpponent: document.getElementById('editScoreOpponent').value
            };

            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                showMessage('ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼', 'success');
                closeEditModal();
                
                // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
                setTimeout(() => {
                    loadPreviewData();
                }, 1000);

            } catch (error) {
                console.error('Error:', error);
                showMessage('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚', 'error');
            }
        });

        // å‰Šé™¤ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openDeleteModal(row) {
            document.getElementById('deleteRowIndex').value = row.rowIndex;
            
            const preview = document.getElementById('deletePreview');
            preview.innerHTML = `
                <p style="margin: 5px 0;"><strong>æ—¥ä»˜:</strong> ${escapeHtml(row.date)}</p>
                <p style="margin: 5px 0;"><strong>å¤§ä¼šå:</strong> ${escapeHtml(row.tournament)}</p>
                <p style="margin: 5px 0;"><strong>å¯¾æˆ¦ãƒãƒ¼ãƒ :</strong> ${escapeHtml(row.opponent)}</p>
                <p style="margin: 5px 0;"><strong>ã‚¹ã‚³ã‚¢:</strong> ${escapeHtml(row.scoreMinamiGaoka)} - ${escapeHtml(row.scoreOpponent)}</p>
            `;
            
            document.getElementById('deleteModal').classList.add('show');
        }

        // å‰Šé™¤ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('show');
        }

        // å‰Šé™¤ã‚’å®Ÿè¡Œ
        async function confirmDelete() {
            if (!SCRIPT_URL || SCRIPT_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') {
                showMessage('ã‚¨ãƒ©ãƒ¼: HTMLãƒ•ã‚¡ã‚¤ãƒ«å†…ã®SCRIPT_URLã‚’è¨­å®šã—ã¦ãã ã•ã„', 'error');
                return;
            }

            const rowIndex = parseInt(document.getElementById('deleteRowIndex').value);

            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'delete',
                        rowIndex: rowIndex
                    })
                });

                showMessage('ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸï¼', 'success');
                closeDeleteModal();
                
                // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
                setTimeout(() => {
                    loadPreviewData();
                }, 1000);

            } catch (error) {
                console.error('Error:', error);
                showMessage('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚', 'error');
            }
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        window.onclick = function(event) {
            const editModal = document.getElementById('editModal');
            const deleteModal = document.getElementById('deleteModal');
            
            if (event.target == editModal) {
                closeEditModal();
            }
            if (event.target == deleteModal) {
                closeDeleteModal();
            }
        }
    </script>
</body>
</html>
